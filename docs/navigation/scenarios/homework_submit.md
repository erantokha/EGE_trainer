# Отправка ответов и завершение ДЗ

Предусловия
- есть attempt_id (создан start_homework_attempt)
- на странице собраны ответы пользователя (payload)

Шаги пользователя
1) решить задачи
2) нажать “Завершить”
3) увидеть экран результата (правильно/неправильно)

Внутренние шаги (файлы/функции)
- [tasks/hw.js](../../../tasks/hw.js) / [snapshot](../code/tasks/hw.js)
  - собирает payload ответов и метрики (total/correct/duration_ms)
  - вызывает submitHomeworkAttempt(attempt_id, payload, total, correct, duration_ms)
  - после ok запрашивает результат для рендера (чтобы даже при перезагрузке/повторе показать итог)
- [app/providers/homework.js](../../../app/providers/homework.js) / [snapshot](../code/app/providers/homework.js)
  - submitHomeworkAttempt → rpc submit_homework_attempt
  - getHomeworkAttemptByToken → rpc get_homework_attempt_by_token (канонический путь чтения результата)
  - fallback (только для диагностики): select homework_attempts по attempt_id, если RPC недоступна и RLS разрешает

Запросы к Supabase (контур)
- rpc submit_homework_attempt (write homework_attempts)
- rpc get_homework_attempt_by_token (read итогов для экрана результата)
- (автоматически) trigger homework_attempts → answer_events (для статистики)

Контракт поведения (фиксируем для разработки)
- попытка считается финализированной после успешного `submit_homework_attempt(...)`
- повторный вызов `submit_homework_attempt(...)` для той же попытки:
  - не создаёт дублей в `homework_attempts` и `answer_events`
  - возвращает успех (либо статус вроде already_submitted)
  - итоговые числа (total/correct/duration_ms) соответствуют сохранённым данным
- UI (tasks/hw.js):
  - первый клик по Завершить блокирует повторный клик до ответа сервера
  - после успеха показывается экран результата
  - после перезагрузки страницы показывается экран результата (если попытка уже завершена)

Итоговые состояния
- homework_attempts: payload + итоговые поля (total/correct/duration_ms, finished_at)
- answer_events: есть события для статистики (через триггер)

Типовые поломки и где чинить
- “Завершить” иногда не показывает экран результата:
  - причины: гонки (двойной клик), потеря состояния до запроса результата, частичный сабмит
  - чинить:
    - фронт: disable кнопки на время сабмита + единый обработчик + обязательный повторный fetch результата после ok
    - БД: идемпотентность submit_homework_attempt + защита от дублей в триггере
- после перезагрузки пишет “уже сдано”, но нет экрана результата:
  - чинить: ветка загрузки результата в tasks/hw.js (должна рендерить итог при finished_at)

Приёмка (проверки)
- два быстрых клика по Завершить: результат один, дублей событий нет
- обновление страницы после завершения: показывается экран результата
- повторное открытие ссылки на ДЗ после сдачи: показывается экран результата
- двойной клик по “Завершить”:
  - должна быть одна попытка, без дублей событий, итог показывается
- перезагрузка страницы сразу после сабмита:
  - итог поднимается из БД и показывается
